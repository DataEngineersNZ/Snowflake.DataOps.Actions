name: Removes the Manifest for the database
description: Removes an existing dbt manifest.json from the storage account
inputs:
  use-azure-federated-login:
    description: Specifies if the action should use Azure Federated Login or Azure Service Principal ClientID/ClientSecret
    default: false
  resource-group:
    description: The resource group where the storage account is located
    required: true
  storage-account:
    description: The name of the storage account
    required: true
  snowflake-target-database:
    description: The name of the database to set the manifest for
    required: true

permissions:
  id-token: write
  contents: read
runs:
  using: "composite"
  steps:
      - name: Authenticate to Azure as a Service Principal
        uses: azure/login@v2
        condition: ${{ inputs.use-azure-federated-login == 'false' }}
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Authenticate to Azure as a Service Principal (ODIC)
        uses: azure/login@v2
        condition: ${{ inputs.use-azure-federated-login == 'true' }}
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      - name: Clone Manifest file
        uses: azure/CLI@v2
        with:
          inlineScript: |
              if $(az storage blob exists --container-name 'manifests' --name ${{ inputs.snowflake-target-database }}_manifest.json --account-name ${{ inputs.storage-account }} --query exists --auth-mode login)
              then
                echo " ==> DBT manifest exists in the container, deleting file"
                az storage blob delete \
                  --account-name ${{ inputs.storage-account }} \
                  --container-name 'manifests' \
                  --name '${{ inputs.snowflake-target-database }}_manifest.json' \
                  --delete-snapshots include \
                  --auth-mode login
              fi

      # Azure logout
      - name: logout
        shell: bash
        run: |
              az logout
        if: always()